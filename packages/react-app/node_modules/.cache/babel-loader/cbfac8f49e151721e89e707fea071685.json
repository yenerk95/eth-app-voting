{"ast":null,"code":"/*!\n * aead.js - aead for bcrypto\n * Copyright (c) 2016-2019, Christopher Jeffrey (MIT License).\n * https://github.com/bcoin-org/bcrypto\n *\n * Resources:\n *   https://tools.ietf.org/html/rfc7539#section-2.8\n *   https://github.com/openssh/openssh-portable\n */\n'use strict';\n\nconst assert = require('../internal/assert');\n\nconst ChaCha20 = require('./chacha20');\n\nconst Poly1305 = require('./poly1305');\n/**\n * AEAD\n */\n\n\nclass AEAD {\n  /**\n   * Create an AEAD context.\n   * @constructor\n   */\n  constructor() {\n    this.chacha = new ChaCha20();\n    this.poly = new Poly1305();\n    this.key = Buffer.alloc(64);\n    this.mode = -1;\n    this.aadLen = 0;\n    this.cipherLen = 0;\n  }\n  /**\n   * Initialize the AEAD with a key and iv.\n   * @param {Buffer} key\n   * @param {Buffer} iv - IV / packet sequence number.\n   */\n\n\n  init(key, iv) {\n    assert(Buffer.isBuffer(key));\n    assert(Buffer.isBuffer(iv));\n    this.key.fill(0x00);\n    this.chacha.init(key, iv, 0);\n    this.chacha.encrypt(this.key);\n    this.poly.init(this.key);\n    this.mode = 0;\n    this.aadLen = 0;\n    this.cipherLen = 0;\n    return this;\n  }\n  /**\n   * Update the aad (will be finalized\n   * on an encrypt/decrypt call).\n   * @param {Buffer} aad\n   */\n\n\n  aad(data) {\n    if (this.mode === -1) throw new Error('Context is not initialized.');\n    if (this.mode !== 0) throw new Error('Invalid state for aad.');\n    this.poly.update(data);\n    this.aadLen += data.length;\n    return this;\n  }\n  /**\n   * Encrypt a piece of data.\n   * @param {Buffer} data\n   */\n\n\n  encrypt(data) {\n    if (this.mode === -1) throw new Error('Context is not initialized.');\n    if (this.mode !== 0 && this.mode !== 1) throw new Error('Invalid state for encrypt.');\n\n    if (this.mode === 0) {\n      this._pad16(this.aadLen);\n\n      this.mode = 1;\n    }\n\n    this.chacha.encrypt(data);\n    this.poly.update(data);\n    this.cipherLen += data.length;\n    return data;\n  }\n  /**\n   * Decrypt a piece of data.\n   * @param {Buffer} data\n   */\n\n\n  decrypt(data) {\n    assert(Buffer.isBuffer(data));\n    if (this.mode === -1) throw new Error('Context is not initialized.');\n    if (this.mode !== 0 && this.mode !== 2) throw new Error('Invalid state for decrypt.');\n\n    if (this.mode === 0) {\n      this._pad16(this.aadLen);\n\n      this.mode = 2;\n    }\n\n    this.cipherLen += data.length;\n    this.poly.update(data);\n    this.chacha.encrypt(data);\n    return data;\n  }\n  /**\n   * Authenticate data without decrypting.\n   * @param {Buffer} data\n   */\n\n\n  auth(data) {\n    assert(Buffer.isBuffer(data));\n    if (this.mode === -1) throw new Error('Context is not initialized.');\n    if (this.mode !== 0 && this.mode !== 3) throw new Error('Invalid state for auth.');\n\n    if (this.mode === 0) {\n      this._pad16(this.aadLen);\n\n      this.mode = 3;\n    }\n\n    this.cipherLen += data.length;\n    this.poly.update(data);\n    return data;\n  }\n  /**\n   * Finalize the aead and generate a MAC.\n   * @returns {Buffer} MAC\n   */\n\n\n  final() {\n    if (this.mode === -1) throw new Error('Context is not initialized.');\n    const len = Buffer.allocUnsafe(16);\n    writeU64(len, this.aadLen, 0);\n    writeU64(len, this.cipherLen, 8);\n    if (this.mode === 0) this._pad16(this.aadLen);\n\n    this._pad16(this.cipherLen);\n\n    this.poly.update(len);\n    const mac = this.poly.final();\n    this.destroy();\n    return mac;\n  }\n  /**\n   * Destroy the context.\n   */\n\n\n  destroy() {\n    this.chacha.destroy();\n    this.poly.destroy();\n\n    for (let i = 0; i < 64; i++) this.key[i] = 0;\n\n    this.mode = -1;\n    this.aadLen = 0;\n    this.cipherLen = 0;\n    return this;\n  }\n  /**\n   * Finalize and verify MAC against tag.\n   * @param {Buffer} tag\n   * @returns {Boolean}\n   */\n\n\n  verify(tag) {\n    assert(Buffer.isBuffer(tag));\n    assert(tag.length === 16);\n    const mac = this.final();\n    let z = 0;\n\n    for (let i = 0; i < 16; i++) z |= mac[i] ^ tag[i];\n\n    return z - 1 >>> 31 !== 0;\n  }\n  /**\n   * Pad a chunk before updating mac.\n   * @private\n   * @param {Number} size\n   */\n\n\n  _pad16(size) {\n    const pos = size & 15;\n    if (pos === 0) return;\n    const pad = Buffer.allocUnsafe(16 - pos);\n    pad.fill(0x00);\n    this.poly.update(pad);\n  }\n  /**\n   * Encrypt a piece of data.\n   * @param {Buffer} key\n   * @param {Buffer} iv\n   * @param {Buffer} msg\n   * @param {Buffer?} aad\n   * @returns {Buffer} tag\n   */\n\n\n  static encrypt(key, iv, msg, aad) {\n    const aead = new AEAD();\n    aead.init(key, iv);\n    if (aad) aead.aad(aad);\n    aead.encrypt(msg);\n    return aead.final();\n  }\n  /**\n   * Decrypt a piece of data.\n   * @param {Buffer} key\n   * @param {Buffer} iv\n   * @param {Buffer} msg\n   * @param {Buffer} tag\n   * @param {Buffer?} aad\n   * @returns {Boolean}\n   */\n\n\n  static decrypt(key, iv, msg, tag, aad) {\n    const aead = new AEAD();\n    aead.init(key, iv);\n    if (aad) aead.aad(aad);\n    aead.decrypt(msg);\n    return aead.verify(tag);\n  }\n  /**\n   * Authenticate data without decrypting.\n   * @param {Buffer} key\n   * @param {Buffer} iv\n   * @param {Buffer} msg\n   * @param {Buffer} tag\n   * @param {Buffer?} aad\n   * @returns {Boolean}\n   */\n\n\n  static auth(key, iv, msg, tag, aad) {\n    const aead = new AEAD();\n    aead.init(key, iv);\n    if (aad) aead.aad(aad);\n    aead.auth(msg);\n    return aead.verify(tag);\n  }\n\n}\n/*\n * Static\n */\n\n\nAEAD.native = ChaCha20.native;\n/*\n * Helpers\n */\n\nfunction writeU32(dst, num, off) {\n  dst[off++] = num;\n  num >>>= 8;\n  dst[off++] = num;\n  num >>>= 8;\n  dst[off++] = num;\n  num >>>= 8;\n  dst[off++] = num;\n  return off;\n}\n\nfunction writeU64(dst, num, off) {\n  const hi = num * (1 / 0x100000000) >>> 0;\n  const lo = num >>> 0;\n  writeU32(dst, lo, off + 0);\n  writeU32(dst, hi, off + 4);\n  return off + 8;\n}\n/*\n * Expose\n */\n\n\nmodule.exports = AEAD;","map":{"version":3,"sources":["/Users/yenerkaraca/Documents/GitHub/eth-app/node_modules/bcrypto/lib/js/aead.js"],"names":["assert","require","ChaCha20","Poly1305","AEAD","constructor","chacha","poly","key","Buffer","alloc","mode","aadLen","cipherLen","init","iv","isBuffer","fill","encrypt","aad","data","Error","update","length","_pad16","decrypt","auth","final","len","allocUnsafe","writeU64","mac","destroy","i","verify","tag","z","size","pos","pad","msg","aead","native","writeU32","dst","num","off","hi","lo","module","exports"],"mappings":"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","sourcesContent":["/*!\n * aead.js - aead for bcrypto\n * Copyright (c) 2016-2019, Christopher Jeffrey (MIT License).\n * https://github.com/bcoin-org/bcrypto\n *\n * Resources:\n *   https://tools.ietf.org/html/rfc7539#section-2.8\n *   https://github.com/openssh/openssh-portable\n */\n\n'use strict';\n\nconst assert = require('../internal/assert');\nconst ChaCha20 = require('./chacha20');\nconst Poly1305 = require('./poly1305');\n\n/**\n * AEAD\n */\n\nclass AEAD {\n  /**\n   * Create an AEAD context.\n   * @constructor\n   */\n\n  constructor() {\n    this.chacha = new ChaCha20();\n    this.poly = new Poly1305();\n    this.key = Buffer.alloc(64);\n    this.mode = -1;\n    this.aadLen = 0;\n    this.cipherLen = 0;\n  }\n\n  /**\n   * Initialize the AEAD with a key and iv.\n   * @param {Buffer} key\n   * @param {Buffer} iv - IV / packet sequence number.\n   */\n\n  init(key, iv) {\n    assert(Buffer.isBuffer(key));\n    assert(Buffer.isBuffer(iv));\n\n    this.key.fill(0x00);\n    this.chacha.init(key, iv, 0);\n    this.chacha.encrypt(this.key);\n    this.poly.init(this.key);\n\n    this.mode = 0;\n    this.aadLen = 0;\n    this.cipherLen = 0;\n\n    return this;\n  }\n\n  /**\n   * Update the aad (will be finalized\n   * on an encrypt/decrypt call).\n   * @param {Buffer} aad\n   */\n\n  aad(data) {\n    if (this.mode === -1)\n      throw new Error('Context is not initialized.');\n\n    if (this.mode !== 0)\n      throw new Error('Invalid state for aad.');\n\n    this.poly.update(data);\n    this.aadLen += data.length;\n\n    return this;\n  }\n\n  /**\n   * Encrypt a piece of data.\n   * @param {Buffer} data\n   */\n\n  encrypt(data) {\n    if (this.mode === -1)\n      throw new Error('Context is not initialized.');\n\n    if (this.mode !== 0 && this.mode !== 1)\n      throw new Error('Invalid state for encrypt.');\n\n    if (this.mode === 0) {\n      this._pad16(this.aadLen);\n      this.mode = 1;\n    }\n\n    this.chacha.encrypt(data);\n    this.poly.update(data);\n\n    this.cipherLen += data.length;\n\n    return data;\n  }\n\n  /**\n   * Decrypt a piece of data.\n   * @param {Buffer} data\n   */\n\n  decrypt(data) {\n    assert(Buffer.isBuffer(data));\n\n    if (this.mode === -1)\n      throw new Error('Context is not initialized.');\n\n    if (this.mode !== 0 && this.mode !== 2)\n      throw new Error('Invalid state for decrypt.');\n\n    if (this.mode === 0) {\n      this._pad16(this.aadLen);\n      this.mode = 2;\n    }\n\n    this.cipherLen += data.length;\n\n    this.poly.update(data);\n    this.chacha.encrypt(data);\n\n    return data;\n  }\n\n  /**\n   * Authenticate data without decrypting.\n   * @param {Buffer} data\n   */\n\n  auth(data) {\n    assert(Buffer.isBuffer(data));\n\n    if (this.mode === -1)\n      throw new Error('Context is not initialized.');\n\n    if (this.mode !== 0 && this.mode !== 3)\n      throw new Error('Invalid state for auth.');\n\n    if (this.mode === 0) {\n      this._pad16(this.aadLen);\n      this.mode = 3;\n    }\n\n    this.cipherLen += data.length;\n\n    this.poly.update(data);\n\n    return data;\n  }\n\n  /**\n   * Finalize the aead and generate a MAC.\n   * @returns {Buffer} MAC\n   */\n\n  final() {\n    if (this.mode === -1)\n      throw new Error('Context is not initialized.');\n\n    const len = Buffer.allocUnsafe(16);\n\n    writeU64(len, this.aadLen, 0);\n    writeU64(len, this.cipherLen, 8);\n\n    if (this.mode === 0)\n      this._pad16(this.aadLen);\n\n    this._pad16(this.cipherLen);\n    this.poly.update(len);\n\n    const mac = this.poly.final();\n\n    this.destroy();\n\n    return mac;\n  }\n\n  /**\n   * Destroy the context.\n   */\n\n  destroy() {\n    this.chacha.destroy();\n    this.poly.destroy();\n\n    for (let i = 0; i < 64; i++)\n      this.key[i] = 0;\n\n    this.mode = -1;\n    this.aadLen = 0;\n    this.cipherLen = 0;\n\n    return this;\n  }\n\n  /**\n   * Finalize and verify MAC against tag.\n   * @param {Buffer} tag\n   * @returns {Boolean}\n   */\n\n  verify(tag) {\n    assert(Buffer.isBuffer(tag));\n    assert(tag.length === 16);\n\n    const mac = this.final();\n\n    let z = 0;\n\n    for (let i = 0; i < 16; i++)\n      z |= mac[i] ^ tag[i];\n\n    return ((z - 1) >>> 31) !== 0;\n  }\n\n  /**\n   * Pad a chunk before updating mac.\n   * @private\n   * @param {Number} size\n   */\n\n  _pad16(size) {\n    const pos = size & 15;\n\n    if (pos === 0)\n      return;\n\n    const pad = Buffer.allocUnsafe(16 - pos);\n\n    pad.fill(0x00);\n\n    this.poly.update(pad);\n  }\n\n  /**\n   * Encrypt a piece of data.\n   * @param {Buffer} key\n   * @param {Buffer} iv\n   * @param {Buffer} msg\n   * @param {Buffer?} aad\n   * @returns {Buffer} tag\n   */\n\n  static encrypt(key, iv, msg, aad) {\n    const aead = new AEAD();\n\n    aead.init(key, iv);\n\n    if (aad)\n      aead.aad(aad);\n\n    aead.encrypt(msg);\n\n    return aead.final();\n  }\n\n  /**\n   * Decrypt a piece of data.\n   * @param {Buffer} key\n   * @param {Buffer} iv\n   * @param {Buffer} msg\n   * @param {Buffer} tag\n   * @param {Buffer?} aad\n   * @returns {Boolean}\n   */\n\n  static decrypt(key, iv, msg, tag, aad) {\n    const aead = new AEAD();\n\n    aead.init(key, iv);\n\n    if (aad)\n      aead.aad(aad);\n\n    aead.decrypt(msg);\n\n    return aead.verify(tag);\n  }\n\n  /**\n   * Authenticate data without decrypting.\n   * @param {Buffer} key\n   * @param {Buffer} iv\n   * @param {Buffer} msg\n   * @param {Buffer} tag\n   * @param {Buffer?} aad\n   * @returns {Boolean}\n   */\n\n  static auth(key, iv, msg, tag, aad) {\n    const aead = new AEAD();\n\n    aead.init(key, iv);\n\n    if (aad)\n      aead.aad(aad);\n\n    aead.auth(msg);\n\n    return aead.verify(tag);\n  }\n}\n\n/*\n * Static\n */\n\nAEAD.native = ChaCha20.native;\n\n/*\n * Helpers\n */\n\nfunction writeU32(dst, num, off) {\n  dst[off++] = num;\n  num >>>= 8;\n  dst[off++] = num;\n  num >>>= 8;\n  dst[off++] = num;\n  num >>>= 8;\n  dst[off++] = num;\n  return off;\n}\n\nfunction writeU64(dst, num, off) {\n  const hi = (num * (1 / 0x100000000)) >>> 0;\n  const lo = num >>> 0;\n\n  writeU32(dst, lo, off + 0);\n  writeU32(dst, hi, off + 4);\n\n  return off + 8;\n}\n\n/*\n * Expose\n */\n\nmodule.exports = AEAD;\n"]},"metadata":{},"sourceType":"script"}